<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KLM ‚Äì Jadwal Sholat</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f2027">

<style>
html, body{height:100%;margin:0;padding:0;}
body{
    font-family:Poppins,sans-serif;
    background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
    color:#fff;
    display:flex;
    justify-content:center;
    align-items:center;
    overflow:hidden;
}
.main-container{text-align:center;width:100%;overflow:auto;max-height:100vh}
h1{font-size:3rem;margin:4px 0}
#clock{font-size:3rem;color:#00ffd5}
table{
    width:90%;max-width:400px;margin:auto;
    border-collapse:collapse;
    background:rgba(255,255,255,.1);
    border-radius:12px;overflow:hidden
}
th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.2)}
th{background:rgba(0,255,213,.3)}
td.next{background:rgba(0,255,213,.2);font-weight:700}
button,input{
    width:70%;max-width:220px;
    padding:8px;margin:6px;
    border:none;border-radius:12px;
    font-weight:700
}
button{background:#00ffd5;cursor:pointer}
input{text-align:center}

.alarm-box{
    margin-top:12px;
    padding:10px;
    background:rgba(255,255,255,.1);
    border-radius:12px;
}
.alarm-item{font-size:.9rem}
</style>
</head>

<body>
<div class="main-container">
  <h1>KLM Pro</h1>
  <p>Jadwal Sholat Pamekasan</p>

  <div id="clock"></div>
  <div id="date"></div>
  <div id="countdown"></div>

  <table>
    <tr><th>Sholat</th><th>Waktu</th></tr>
    <tr><td>Subuh</td><td id="FajrTime">--:--</td></tr>
    <tr><td>Dzuhur</td><td id="DhuhrTime">--:--</td></tr>
    <tr><td>Ashar</td><td id="AsrTime">--:--</td></tr>
    <tr><td>Maghrib</td><td id="MaghribTime">--:--</td></tr>
    <tr><td>Isya</td><td id="IshaTime">--:--</td></tr>
  </table>

  <button id="enableNotification">Aktifkan Notifikasi</button>
  <button id="testNotification">Tes Notifikasi</button>

  <div class="alarm-box">
    <h3>‚è∞ Alarm Custom</h3>
    <input type="time" id="alarmTime">
    <button id="addAlarm">Tambah Alarm</button>
    <div id="alarmList"></div>
  </div>
</div>

<script>
// ===== SERVICE WORKER =====
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}

// ===== JAM =====
const clockEl=document.getElementById("clock");
const dateEl=document.getElementById("date");
const countdownEl=document.getElementById("countdown");

function updateClock(){
  const n=new Date();
  clockEl.textContent=n.toLocaleTimeString("id-ID",{hour12:false});
  dateEl.textContent=n.toLocaleDateString("id-ID",{weekday:"long",day:"numeric",month:"long",year:"numeric"});
}
updateClock();
setInterval(updateClock,1000);

// ===== JADWAL SHOLAT =====
const city="Pamekasan", country="ID";
let jadwal={}, notifDone={};

async function fetchJadwal(){
  const d=new Date();
  const res=await fetch(
    `https://api.aladhan.com/v1/calendarByCity?city=${city}&country=${country}&method=2&month=${d.getMonth()+1}&year=${d.getFullYear()}`
  );
  const t=(await res.json()).data[d.getDate()-1].timings;

  ["Fajr","Dhuhr","Asr","Maghrib","Isha"].forEach(s=>{
    jadwal[s]=t[s].split(" ")[0];
    document.getElementById(s+"Time").textContent=jadwal[s];
  });

  notifDone={};
}
fetchJadwal();

// ===== NOTIF SHOLAT =====
enableNotification.onclick=async()=>{
  const izin=await Notification.requestPermission();
  if(izin!=="granted") return;

  setInterval(async()=>{
    const now=new Date().toTimeString().slice(0,5);
    for(const s in jadwal){
      if(now===jadwal[s] && !notifDone[s]){
        const reg=await navigator.serviceWorker.ready;
        reg.showNotification("üïå Pengingat Sholat",{
          body:`Sekarang masuk waktu sholat ${s}`,
          requireInteraction:true,
          tag:"sholat-"+s
        });
        notifDone[s]=true;
      }
    }
  },30000);
};

// ===== TES NOTIF =====
testNotification.onclick=async()=>{
  const reg=await navigator.serviceWorker.ready;
  reg.showNotification("üîî Tes Notifikasi",{
    body:"Notifikasi berhasil muncul",
    requireInteraction:true
  });
};

// ===== COUNTDOWN =====
setInterval(()=>{
  if(!Object.keys(jadwal).length) return;
  const now=new Date();

  const list=Object.entries(jadwal).map(([k,v])=>{
    const [h,m]=v.split(":").map(Number);
    const t=new Date();
    t.setHours(h,m,0,0);
    if(t<=now) t.setDate(t.getDate()+1);
    return {k,t};
  }).sort((a,b)=>a.t-b.t);

  const diff=list[0].t-now;
  const jam=Math.floor(diff/3600000);
  const menit=Math.floor(diff/60000)%60;
  countdownEl.textContent=`${list[0].k} dalam ${jam} jam ${menit} menit`;
},1000);

// ===== ALARM CUSTOM =====
let alarms=JSON.parse(localStorage.getItem("alarms")||"[]");
const alarmList=document.getElementById("alarmList");

function renderAlarms(){
  alarmList.innerHTML="";
  alarms.forEach(a=>{
    const d=document.createElement("div");
    d.className="alarm-item";
    d.textContent="‚è∞ "+a;
    alarmList.appendChild(d);
  });
}
renderAlarms();

addAlarm.onclick=()=>{
  if(!alarmTime.value) return;
  alarms.push(alarmTime.value);
  localStorage.setItem("alarms",JSON.stringify(alarms));
  renderAlarms();
  alarmTime.value="";
};

setInterval(async()=>{
  const now=new Date().toTimeString().slice(0,5);
  for(let i=alarms.length-1;i>=0;i--){
    if(now===alarms[i]){
      const reg=await navigator.serviceWorker.ready;
      reg.showNotification("‚è∞ Alarm Custom",{
        body:`Alarm pukul ${alarms[i]}`,
        requireInteraction:true,
        tag:"alarm-"+alarms[i]
      });
      alarms.splice(i,1);
      localStorage.setItem("alarms",JSON.stringify(alarms));
      renderAlarms();
    }
  }
},30000);
</script>
</body>
</html>